(function ($, sp) { "use strict"; var userinfo; var imChat; var isLoaded = 0; $.imServer = { init: function () { $.imServer.getUserInfo(function () { }) }, connect: function () { $.ajax({ url: userinfo.imUrl + "/hubs", type: "get", dataType: "text", success: function (data) { eval(data); console.log(userinfo); $.connection.hub.url = userinfo.imUrl; $.connection.hub.qs = { "userId": userinfo.userId }; imChat = $.connection.ChatsHub; $.imServer.registerClient(); $.connection.hub.start().done(function () { $.imServer.afterSuccess() }); $.connection.hub.disconnected(function () { $.imServer.disconnected() }) }, error: function (XMLHttpRequest, textStatus, errorThrown) { isLoaded = -1 }, }) }, afterSuccess: function () { isLoaded = 1 }, disconnected: function () { }, registerClient: function () { if (imChat) { imChat.client.revMsg = function (formUser, msg, dateTime) { } } }, registerServer: function () { $.imServer.getUserList = function (departmentId, callback) { console.log(isLoaded); if (isLoaded == 1) { imChat.server.getUserList(departmentId).done(function (list) { if (!!callback) { callback(list) } }) } else if (isLoaded == 0) { setTimeout(function () { $.imServer.getUserList(departmentId, callback) }, 500) } } }, getUserInfo: function (callback) { userinfo = sp.clientdata.get(['userinfo']); if (!!userinfo) { callback() } else { setTimeout(function () { $.imServer.getUserInfo(callback) }, 100) } } } })(jQuery, top.sp); (function ($, sp) { "use strict"; var userinfo; var isWindowOpen = false; $.spIM = { init: function () { $._spIM.render() }, addMsgTolist: function (id, name, msg, img) { var $list = $('#sp_im_last_list'); var $item = $list.find('[data-value="' + id + '"]'); if ($item.length > 0) { } else { var _html = '<li data-value="' + id + '">'; _html += '<img src="' + top.$.rootUrl + '/Content/images/spim/' + img + '">'; _html += ''; _html += '<div class="sp-im-onemsg">'; _html += '<p class="sp-im-onemsg-title">' + name + '</p>'; _html += '<p class="sp-im-onemsg-content">' + msg + '</p>'; _html += '</div></li>' } }, updateMsgNum: function (id, num) { } }; $._spIM = { render: function () { var _html = '<div class="sp-im-icon"  ><a href="javascript:;" id="sp_imicon_btn" title="企业内部通讯"><i class="fa fa-commenting"></i><span class="label label-success"></span></a></div>'; _html += '<div class="sp-im-wrap" >'; _html += '<div class="sp-im-user-list" style="display:none;" id="sp_im_list" >'; _html += '<div class="sp-im-header">企业内部通讯<div class="sp-im-close"><a id="sp_im_close" href="javascript:;">×</a></div></div>'; _html += '<div class="sp-im-search"><input type="text" placeholder="搜索：同事名称、讨论组名称"><i class="fa fa-search"></i></div>'; _html += '<div class="sp-im-body">'; _html += '<div class="sp-im-body-nav" id="sp_im_list_nav" ><ul>'; _html += '<li class="active nav_tab" data-value="last"><a title="最近回话"><i class="fa fa-comment"></i></a></li>'; _html += '<li class="nav_tab" data-value="user"><a title="联系人"><i class="fa fa-user"></i></a></li>'; _html += '<li class="nav_tab" data-value="group"><a title="讨论组"><i class="fa fa-users" style="font-size: 20px;"></i></a></li>'; _html += '</ul></div>'; _html += '<div class="sp-im-body-list" id="sp_im_body_list">'; _html += '<div id="sp_im_last_list" class="sp_im_body_ul active" ></div>'; _html += '<div id="sp_im_user_list" class="sp_im_body_user" style="display:none;" ><div class="sp-top-department" > <div id="im_department"></div> </div><div class="sp-userlist-content" id="sp_userlist_content" > <ul id="sp_userlist" class="sp-im-chatlist"></ul></div></div>'; _html += '<div id="sp_im_group_list" class="sp_im_body_ul" style="display:none;" ></div>'; _html += '</div>'; _html += '</div>'; _html += '</div>'; _html += '<div class="sp-im-window" style="display:none;" id="sp_im_window">'; _html += '<div class="sp-im-window-header"><span class="text"></span><div class="close"><a href="javascript:;">×</a></div></div>'; _html += '<div class="sp-im-window-chat">'; _html += '<div class="sp-im-window-content">'; _html += '</div></div>'; _html += '<div class="sp-im-window-tool"><a class="sp-im-window-tool-chatlogbtn "><i class="fa fa-clock-o"></i>沟通记录</a></div>'; _html += '<div class="sp-im-window-send"><textarea autofocus placeholder="按回车发送消息,shift+回车换行"></textarea></div>'_html += '</div>'; _html += '</div>'; $('body').append(_html); $('#sp_imicon_btn').on('click', function () { var $im = $('#sp_im_list'); if ($im.is(':hidden')) { $im.show() } }); $('#sp_im_close').on('click', function () { var $im = $('#sp_im_list'); var $im_message_window = $('#sp_im_window'); $im.hide(); $im_message_window.hide() }); $('#sp_im_list_nav li').on('click', function () { var $this = $(this); if (!$this.hasClass('active')) { var $parent = $this.parent(); $parent.find('.active').removeClass('active'); $this.addClass('active'); var id = '#sp_im_' + $this.attr('data-value') + '_list'; var $list = $(id); $('#sp_im_body_list>div.active').removeClass('active').hide(); $list.addClass('active').show() } }); $('#sp_im_body_list').delegate(".sp-user-item", "click", function (e) { var $this = $(this); var userId = $this.attr('data-value'); var userName = $this.find('a').text(); console.log(userId); $._spIM.openWindow(userId, userName) }); var $textarea = $('#sp_im_window .sp-im-window-send'); $textarea.delegate("textarea", 'keypress', function (e) { var keyCode = e.keyCode || e.which || e.charCode; var shiftKey = e.shiftKey || e.metaKey; if (shiftKey && keyCode == "13") { } else if (keyCode == "13" && isWindowOpen) { var sendText = $(this).val(); if (sendText) { $._spIM.addRightMsg(userinfo.realName, sp.getDate('yyyy-MM-dd hh:mm'), $._spIM.getUserImg(), sendText) } $('#sp_im_window .sp-im-window-send').html('<textarea autofocus placeholder="按回车发送消息,shift+回车换行"></textarea>'); setTimeout(function () { $('#sp_im_window .sp-im-window-send>textarea').focus() }, 100); e.preventDefault(); return false } }); $('#im_department').spselect({ type: 'tree', maxHeight: 343, allowSearch: true, url: top.$.rootUrl + '/LR_OrganizationModule/Department/GetTree', param: { companyId: '', parentId: '' }, placeholder: '请选择部门', select: function (department) { var $list = $('#sp_userlist'); $list.html(""); $.imServer.getUserList(department.value, function (list) { $.each(list, function (id, item) { $list.append($._spIM.getUserHtml(item)) }) }) } }); userinfo = sp.clientdata.get(['userinfo']); $('#im_department').spselectSet(userinfo.departmentId); $('#sp_userlist_content').mCustomScrollbar({ theme: "minimal-dark" }); $('#sp_im_window .sp-im-window-chat').mCustomScrollbar({ theme: "minimal-dark" }) }, initData: function () { }, getUserHtml: function (userItem) { if (userItem.F_UserId != userinfo.userId) { var _li = ''; if (sp.isExistImg(top.$.rootUrl + userItem.F_HeadIcon)) { headimg = top.$.rootUrl + userItem.F_HeadIcon } else if (userItem.F_Gender != 0) { headimg = top.$.rootUrl + '/Content/images/head/on-boy.jpg' } else { headimg = top.$.rootUrl + '/Content/images/head/on-girl.jpg' } _li = '<li class="sp-user-item" data-value="' + userItem.F_UserId + '"  ><img class="headimg" src="' + headimg + '"><a>' + userItem.F_RealName + '</a></li>'; return _li } }, getUserImg: function () { var headimg = ''; if (sp.isExistImg(top.$.rootUrl + userinfo.headIcon)) { headimg = top.$.rootUrl + userinfo.headIcon } else if (userinfo.gender != 0) { headimg = top.$.rootUrl + '/Content/images/head/on-boy.jpg' } else { headimg = top.$.rootUrl + '/Content/images/head/on-girl.jpg' } return headimg }, openWindow: function (userId, userName) { var $window = $('#sp_im_window'); $window.attr('data-value', userId); $window.find('.sp-im-window-header>.text').text(userName); $('#sp_im_window .sp-im-window-content').html(""); $window.show(); isWindowOpen = true }, addRightMsg: function (userName, datatime, img, msg) { var html = '<div class="right"><div class="author-name">'; html += '<small class="chat-date">' + datatime + '</small>'; html += '<small class="chat-text">' + userName + '</small>'; html += '<img src="' + img + '" />'; html += '</div>'; html += '<div class="chat-message"><em></em>' + msg + '</div></div>'; $('#sp_im_window .sp-im-window-content').append(html); $("#sp_im_window .sp-im-window-chat").mCustomScrollbar("scrollTo", 'bottom') } } })(jQuery, top.sp);
