(function ($, sp) { "use strict"; $.spcustmerquery = { init: function ($self) { var dfop = $self[0]._spcustmerquery.dfop; $self.parent().append('<div class="sp-isearch-panel"  style="max-height:' + dfop.maxHeight + 'px;" ><ul id="spisearch_' + dfop.id + '" ></ul></div>') }, bind: function ($self) { $self.on('input propertychange', function () { var $this = $(this); $.spisearch.triggerSearch($self) }) }, triggerSearch: function ($self) { var dfop = $self[0]._spcustmerquery.dfop; var $showPanel = $('#spisearch_' + dfop.id); $showPanel.parent().hide(); var _value = $self.val(); if (_value) { if (!dfop._isload) { dfop._isSearchneed = true } else { dfop._first = true; dfop._value = _value; dfop._begin = 0; dfop._end = 100 > dfop.data.length ? dfop.data.length : 100; if (dfop._isSearched) { dfop._isSearched = false; setTimeout(function () { $.spisearch.search($self) }) } } } else { dfop._isSearchneed = false; $showPanel.html("") } }, search: function ($self) { var dfop = $self[0]._spcustmerquery.dfop; var value = dfop._value; var begin = dfop._begin; var end = dfop._end; var data = dfop.data; for (var i = begin; i < end; i++) { var _item = data[i]; if (item[dfop.text].indexOf(value) != -1) { $.spisearch.renderNone($self, item[dfop.text]) } } if (end < data.length) { dfop._begin = end; dfop._end = end + 100; if (dfop._end > data.length) { dfop._end = data.length } setTimeout(function () { $.spisearch.search($self) }) } else { dfop._isSearched = true } }, renderNone: function ($self, text) { var dfop = $self[0]._spcustmerquery.dfop; var $showPanel = $('#spisearch_' + dfop.id); if (dfop._first) { dfop._first = false; $showPanel.html(""); $showPanel.parent().show() } $showPanel.append('<li>' + text + '</li>') } }; $.fn.spcustmerquery = function (op) { var dfop = { dfData: [], Fields: [], moduleUrl: '', url: top.$.rootUrl + '/LR_SystemModule/CustmerQuery/GetList', data: [], _isload: false }; $.extend(dfop, op || {}); var $self = $(this); dfop.id = $self.attr('id'); if (!dfop.id) { return false } $self[0]._spcustmerquery = { "dfop": dfop }; $.spcustmerquery.init($self); if (!!dfop.url) { sp.httpAsync('GET', dfop.url, dfop.param, function (data) { $self[0]._spcustmerquery.dfop.data = data || []; dfop._isload = true }) } return $self } })(jQuery, top.sp);
